generator client {
  provider = "prisma-client-js"
}

// --- HR On/Offboarding ---

enum TaskType {
  ONBOARDING
  OFFBOARDING
}

model TaskTemplate {
  id              String        @id @default(cuid())
  title           String
  description     String?
  type            TaskType
  // Legacy column to satisfy db push in environments that still have it
  ownerRole       String?
  // New relational role; renamed field to avoid name clash with legacy column
  role            LifecycleRole? @relation("LifecycleRoleTaskTemplates", fields: [ownerRoleId], references: [id])
  ownerRoleId     String?
  relativeDueDays Int           // relative to startDate/exitDate depending on type
  active          Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  assignments TaskAssignment[]

  @@unique([title, type])
}

model TaskAssignment {
  id             String        @id @default(cuid())
  employee       Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId     String
  template       TaskTemplate  @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  taskTemplateId String
  type           TaskType
  status         LifecycleStatus @relation("LifecycleStatusTaskAssignments", fields: [statusId], references: [id])
  statusId       String
  dueDate        DateTime
  ownerRole      LifecycleRole @relation("LifecycleRoleTaskAssignments", fields: [ownerRoleId], references: [id])
  ownerRoleId    String
  // Legacy columns - mapped as String to match production DB
  ownerRoleLegacy String? @map("ownerRole")
  statusLegacy    String? @map("status")
  notes          String?
  completedAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // optional links for asset/access fulfillment
  assets   Asset[]  @relation("AssignmentAssets")
  accesses Access[] @relation("AssignmentAccesses")

  @@unique([employeeId, taskTemplateId])
  @@index([employeeId, statusId, dueDate])
}

model Asset {
  id                   String          @id @default(cuid())
  assetTag             String?         @unique  // e.g. "HW-2024-0001"
  name                 String
  description          String?
  category             AssetCategory   @default(OTHER)
  serial               String?
  manufacturer         String?
  model                String?
  purchaseDate         DateTime?
  purchasePrice        Decimal?        @db.Decimal(10, 2)
  currentValue         Decimal?        @db.Decimal(10, 2)  // Depreciated value
  warrantyEnd          DateTime?
  status               AssetStatus     @default(IN_STOCK)
  condition            AssetCondition  @default(GOOD)
  // either assigned directly to employee, or linked via task assignment
  assignedToEmployee   Employee?       @relation("EmployeeAssets", fields: [assignedToEmployeeId], references: [id])
  assignedToEmployeeId String?
  assignedAt           DateTime?
  assignment           TaskAssignment? @relation("AssignmentAssets", fields: [assignmentId], references: [id])
  assignmentId         String?
  notes                String?
  transferRequests     AssetTransfer[] // Transfer/purchase requests
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@index([assignedToEmployeeId])
}

enum AssetCategory {
  LAPTOP
  DESKTOP
  MONITOR
  PHONE
  TABLET
  KEYBOARD
  MOUSE
  HEADSET
  DOCKING_STATION
  PRINTER
  CAMERA
  PROJECTOR
  FURNITURE
  OTHER
}

enum AssetStatus {
  IN_STOCK          // Available in inventory
  ASSIGNED          // Assigned to employee
  MAINTENANCE       // Being repaired
  TRANSFER_PENDING  // Transfer/sale in progress
  SOLD              // Sold to employee
  DISPOSED          // Disposed/recycled
  LOST              // Lost or stolen
}

enum AssetCondition {
  NEW
  EXCELLENT
  GOOD
  FAIR
  POOR
}

// Hardware Transfer/Purchase Request
model AssetTransfer {
  id              String              @id @default(cuid())
  transferNumber  String              @unique  // e.g. "TRF-2024-0001"
  asset           Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assetId         String
  employee        Employee            @relation(fields: [employeeId], references: [id])
  employeeId      String
  type            AssetTransferType
  status          AssetTransferStatus @default(PENDING)
  // Pricing
  originalValue   Decimal?            @db.Decimal(10, 2)  // Original purchase price
  depreciatedValue Decimal?           @db.Decimal(10, 2)  // Current book value
  salePrice       Decimal?            @db.Decimal(10, 2)  // Offered sale price
  // Approval workflow
  requestedAt     DateTime            @default(now())
  requestedBy     User                @relation("TransferRequestedBy", fields: [requestedById], references: [id])
  requestedById   String
  approvedAt      DateTime?
  approvedBy      User?               @relation("TransferApprovedBy", fields: [approvedById], references: [id])
  approvedById    String?
  rejectedAt      DateTime?
  rejectedBy      User?               @relation("TransferRejectedBy", fields: [rejectedById], references: [id])
  rejectedById    String?
  rejectionReason String?
  completedAt     DateTime?
  // Employee signature/agreement
  employeeAccepted Boolean            @default(false)
  employeeAcceptedAt DateTime?
  employeeSignature String?           // Digital signature or confirmation
  // Notes and documentation
  reason          String?             @db.Text
  notes           String?             @db.Text
  agreementPdfUrl String?             // Generated PDF agreement
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([assetId])
  @@index([employeeId])
  @@index([status])
}

enum AssetTransferType {
  SALE              // Selling hardware to employee
  GIFT              // Gifting hardware (e.g., old equipment)
  RETURN            // Employee returning hardware
  REASSIGNMENT      // Transferring to another employee
}

enum AssetTransferStatus {
  PENDING           // Awaiting approval
  APPROVED          // Approved, awaiting employee acceptance
  ACCEPTED          // Employee accepted
  REJECTED          // Request rejected
  CANCELLED         // Request cancelled
  COMPLETED         // Transfer completed
}

model Access {
  id                   String          @id @default(cuid())
  system               String
  account              String?
  assignedToEmployee   Employee?       @relation("EmployeeAccesses", fields: [assignedToEmployeeId], references: [id])
  assignedToEmployeeId String?
  assignment           TaskAssignment? @relation("AssignmentAccesses", fields: [assignmentId], references: [id])
  assignmentId         String?
  notes                String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@index([assignedToEmployeeId])
}

model EmployeeDocument {
  id           String   @id @default(cuid())
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId   String
  title        String
  docType      String
  url          String?
  storageKey   String?
  uploadedBy   User?    @relation("EmployeeDocumentUploadedBy", fields: [uploadedById], references: [id])
  uploadedById String?
  createdAt    DateTime @default(now())
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employee {
  id                 String               @id @default(cuid())
  firstName          String
  lastName           String
  startDate          DateTime
  birthDate          DateTime
  email              String?              @unique
  status             EmployeeStatus       @default(ACTIVE)
  exitDate           DateTime?
  jobTitle           String?
  contractType       ContractType?        @default(PERMANENT)
  employmentType     EmploymentType?      @default(FULL_TIME)
  weeklyHours        Int?                 @default(40)
  remoteQuota        Int?                 @default(0)
  unit               Unit?                @relation(fields: [unitId], references: [id])
  unitId             String?
  department         Department?          @relation(fields: [departmentId], references: [id])
  departmentId       String?
  team               Team?                @relation(fields: [teamId], references: [id])
  teamId             String?
  location           Location?            @relation(fields: [locationId], references: [id])
  locationId         String?
  assignments        EmployeeAssignment[]
  absences           Absence[]
  lifecycleProcesses LifecycleProcess[]
  lifecycleTasks     TaskAssignment[]
  assets             Asset[]              @relation("EmployeeAssets")
  accesses           Access[]             @relation("EmployeeAccesses")
  documents          EmployeeDocument[]
  reminders          Reminder[]
  certificates       WorkCertificate[]
  projectApplications ProjectApplication[]
  vehicleAssignments VehicleAssignment[]
  hrTickets          HRTicket[]
  qualifications     EmployeeQualification[]
  assetTransfers     AssetTransfer[]
  lockAll            Boolean              @default(false)
  lockFirstName      Boolean              @default(false)
  lockLastName       Boolean              @default(false)
  lockStartDate      Boolean              @default(false)
  lockBirthDate      Boolean              @default(false)
  lockEmail          Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@unique([firstName, lastName, birthDate])
}

model Unit {
  id           String               @id @default(cuid())
  name         String
  leader       String?
  deputy       String?
  department   Department?          @relation(fields: [departmentId], references: [id])
  departmentId String?
  location     Location?            @relation(fields: [locationId], references: [id])
  locationId   String?
  employees    Employee[]
  teams        Team[]
  users        User[]
  absences     Absence[]
  assignments  EmployeeAssignment[] @relation("AssignmentUnit")
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@unique([name])
}

model Department {
  id          String               @id @default(cuid())
  name        String
  description String?
  units       Unit[]
  employees   Employee[]
  teams       Team[]
  absences    Absence[]
  assignments EmployeeAssignment[] @relation("AssignmentDepartment")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([name])
}

model Team {
  id           String               @id @default(cuid())
  name         String
  unit         Unit?                @relation(fields: [unitId], references: [id])
  unitId       String?
  department   Department?          @relation(fields: [departmentId], references: [id])
  departmentId String?
  employees    Employee[]
  absences     Absence[]
  assignments  EmployeeAssignment[] @relation("AssignmentTeam")
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@unique([name])
}

model Location {
  id          String               @id @default(cuid())
  name        String
  address     String?
  units       Unit[]
  employees   Employee[]
  absences    Absence[]
  assignments EmployeeAssignment[] @relation("AssignmentLocation")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([name])
}

model EmployeeAssignment {
  id             String          @id @default(cuid())
  employee       Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId     String
  unitId         String?
  unit           Unit?           @relation("AssignmentUnit", fields: [unitId], references: [id])
  departmentId   String?
  department     Department?     @relation("AssignmentDepartment", fields: [departmentId], references: [id])
  teamId         String?
  team           Team?           @relation("AssignmentTeam", fields: [teamId], references: [id])
  locationId     String?
  location       Location?       @relation("AssignmentLocation", fields: [locationId], references: [id])
  jobTitle       String?
  contractType   ContractType?
  employmentType EmploymentType?
  weeklyHours    Int?
  remoteQuota    Int?
  startedAt      DateTime        @default(now())
  endedAt        DateTime?
  createdAt      DateTime        @default(now())

  @@index([employeeId, startedAt])
}

enum UserRole {
  ADMIN
  HR
  PEOPLE_MANAGER
  TEAM_LEAD
  UNIT_LEAD
}

enum ContractType {
  PERMANENT
  FIXED_TERM
  FREELANCE
  TEMPORARY
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  WORKING_STUDENT
  INTERN
  APPRENTICE
}

model Absence {
  id             String        @id @default(cuid())
  employee       Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId     String
  unit           Unit?         @relation(fields: [unitId], references: [id])
  unitId         String?
  department     Department?   @relation(fields: [departmentId], references: [id])
  departmentId   String?
  team           Team?         @relation(fields: [teamId], references: [id])
  teamId         String?
  location       Location?     @relation(fields: [locationId], references: [id])
  locationId     String?
  type           AbsenceType   @default(VACATION)
  status         AbsenceStatus @default(PENDING)
  startDate      DateTime
  endDate        DateTime
  description    String?
  managerComment String?
  createdBy      User?         @relation("AbsenceCreatedBy", fields: [createdById], references: [id])
  createdById    String?
  approvedBy     User?         @relation("AbsenceApprovedBy", fields: [approvedById], references: [id])
  approvedById   String?
  approvedAt     DateTime?
  declineReason  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([employeeId, startDate, endDate])
  @@index([unitId, startDate, endDate])
}

enum AbsenceType {
  VACATION
  SICKNESS
  PARENTAL_LEAVE
  TRAINING
  BUSINESS_TRIP
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String?
  passwordHash            String
  role                    UserRole           @default(UNIT_LEAD)
  unit                    Unit?              @relation(fields: [unitId], references: [id])
  unitId                  String?
  sessions                Session[]
  absencesCreated         Absence[]          @relation("AbsenceCreatedBy")
  absencesApproved        Absence[]          @relation("AbsenceApprovedBy")
  documentsUploaded       EmployeeDocument[] @relation("EmployeeDocumentUploadedBy")
  completedLifecycleTasks LifecycleTask[]    @relation("LifecycleTaskCompletedBy")
  certificatesCreated     WorkCertificate[]  @relation("CertificateCreatedBy")
  certificatesApproved    WorkCertificate[]  @relation("CertificateApprovedBy")
  projectsCreated         InternalProject[]  @relation("ProjectCreatedBy")
  applicationsApproved    ProjectApplication[] @relation("ApplicationApprovedBy")
  vehicleCostsCreated     VehicleCost[]      @relation("VehicleCostCreatedBy")
  ticketsCreated          HRTicket[]         @relation("TicketCreatedBy")
  ticketsAssigned         HRTicket[]         @relation("TicketAssignedTo")
  ticketComments          HRTicketComment[]
  transfersRequested      AssetTransfer[]    @relation("TransferRequestedBy")
  transfersApproved       AssetTransfer[]    @relation("TransferApprovedBy")
  transfersRejected       AssetTransfer[]    @relation("TransferRejectedBy")
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

enum EmployeeStatus {
  ACTIVE
  ONBOARDING
  OFFBOARDING
  EXITED
}

model Setting {
  id                     Int     @id @default(1)
  managerEmails          String  @default("")
  birthdayEmailTemplate  String  @default("Happy Birthday, {{firstName}}!")
  jubileeEmailTemplate   String  @default("Congrats on {{years}} years, {{firstName}}!")
  jubileeYearsCsv        String  @default("5,10,15,20,25,30,35,40")
  smtpHost               String  @default("")
  smtpPort               Int     @default(465)
  smtpUser               String  @default("")
  smtpPass               String  @default("")
  smtpFrom               String  @default("")
  smtpSecure             Boolean @default(true)
  smtpRejectUnauthorized Boolean @default(true)
  sendOnBirthday         Boolean @default(true)
  sendOnJubilee          Boolean @default(true)
  dailySendHour          Int     @default(8) // 0-23
}

model EmployeeImportLog {
  id                String   @id @default(cuid())
  created           Int
  updated           Int
  skippedLocked     Int
  exited            Int
  skippedExitLocked Int
  reactivated       Int
  createdAt         DateTime @default(now())
}

// --- On/Offboarding lifecycle ---

enum LifecycleType {
  ONBOARDING
  OFFBOARDING
}

model LifecycleRole {
  id          String               @id @default(cuid())
  key         String               @unique
  label       String
  description String?
  type        LifecycleType?
  orderIndex  Int                  @default(0)
  active      Boolean              @default(true)
  templates   LifecycleTaskTemplate[]
  tasks       LifecycleTask[]
  taskTemplates TaskTemplate[] @relation("LifecycleRoleTaskTemplates")
  taskAssignments TaskAssignment[] @relation("LifecycleRoleTaskAssignments")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model LifecycleStatus {
  id         String           @id @default(cuid())
  key        String           @unique
  label      String
  description String?
  type       LifecycleType?
  orderIndex Int              @default(0)
  active     Boolean          @default(true)
  isDone     Boolean          @default(false)
  isDefault  Boolean          @default(false)
  tasks      LifecycleTask[]
  taskAssignments TaskAssignment[] @relation("LifecycleStatusTaskAssignments")
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model LifecycleTemplate {
  id          String                  @id @default(cuid())
  title       String
  type        LifecycleType
  description String?
  active      Boolean                 @default(true)
  tasks       LifecycleTaskTemplate[]
  processes   LifecycleProcess[]
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@unique([title, type])
}

model LifecycleTaskTemplate {
  id           String            @id @default(cuid())
  template     LifecycleTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId   String
  title        String
  description  String?
  ownerRole    LifecycleRole     @relation(fields: [ownerRoleId], references: [id])
  ownerRoleId  String
  relativeDays Int // relative due date offset from start (onboarding) or exit (offboarding)
  orderIndex   Int               @default(0)
}

model LifecycleProcess {
  id         String            @id @default(cuid())
  employee   Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String
  template   LifecycleTemplate @relation(fields: [templateId], references: [id])
  templateId String
  type       LifecycleType
  startedAt  DateTime          @default(now())
  closedAt   DateTime?
  tasks      LifecycleTask[]
}

model LifecycleTask {
  id            String           @id @default(cuid())
  process       LifecycleProcess @relation(fields: [processId], references: [id], onDelete: Cascade)
  processId     String
  title         String
  description   String?
  ownerRole     LifecycleRole    @relation(fields: [ownerRoleId], references: [id])
  ownerRoleId   String
  status        LifecycleStatus  @relation(fields: [statusId], references: [id])
  statusId      String
  dueDate       DateTime?
  completedAt   DateTime?
  completedBy   User?            @relation("LifecycleTaskCompletedBy", fields: [completedById], references: [id])
  completedById String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([processId])
}

// --- Reminders ---

// Legacy enum - maps to existing "ReminderType" enum in production DB
// Using @map to avoid conflict with new ReminderType model
enum ReminderTypeEnum {
  GEHALT
  MEILENSTEIN
  SONDERBONUS
  STAFFELBONUS
  URLAUBSGELD
  WEIHNACHTSGELD

  @@map("ReminderType")
}

// Named ReminderTypeConfig to avoid conflict with existing ReminderType enum in DB
model ReminderTypeConfig {
  id          String     @id @default(cuid())
  key         String     @unique // e.g. "GEHALT", "CUSTOM_TYPE"
  label       String     // Display name, e.g. "Gehalt", "Sonderbonus"
  description String?
  color       String?    // Optional color for UI (hex or tailwind class)
  orderIndex  Int        @default(0)
  active      Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  reminders   Reminder[]
}

model Reminder {
  id            String        @id @default(cuid())
  // Optional until all existing records are migrated
  reminderTypeConfig  ReminderTypeConfig? @relation(fields: [reminderTypeId], references: [id])
  reminderTypeId String?
  // Legacy field - maps to existing "type" column (uses ReminderType enum in DB)
  typeLegacy    ReminderTypeEnum? @map("type")
  description   String?
  employee    Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId  String
  dueDate     DateTime
  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  schedules   ReminderSchedule[]
  recipients  ReminderRecipient[]
  sendLogs    ReminderSendLog[]
}

model ReminderSchedule {
  id          String    @id @default(cuid())
  reminder    Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  reminderId  String
  label       String
  daysBefore  Int       // 0 = at due date, positive = days before
  timeOfDay   String?   // optional HH:mm for sending window
  orderIndex  Int       @default(0)
}

model ReminderRecipient {
  id          String    @id @default(cuid())
  reminder    Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  reminderId  String
  email       String
  orderIndex  Int       @default(0)
}

model ReminderSendLog {
  id           String    @id @default(cuid())
  reminder     Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  reminderId   String
  scheduleLabel String
  targetEmail  String
  sentAt       DateTime  @default(now())

  @@index([reminderId, sentAt])
  @@unique([reminderId, scheduleLabel, targetEmail, sentAt])
}

// --- Arbeitszeugnisse (Work Certificates) ---

enum CertificateType {
  ZWISCHENZEUGNIS  // Interim certificate
  ENDZEUGNIS       // Final certificate
  EINFACH          // Simple certificate (just dates, no evaluation)
  QUALIFIZIERT     // Qualified certificate (with evaluation)
}

// Categories for text blocks
model CertificateCategory {
  id          String               @id @default(cuid())
  key         String               @unique  // e.g. "INTRO", "TASKS", "PERFORMANCE", "BEHAVIOR", "CLOSING"
  label       String                        // e.g. "Einleitung", "Tätigkeitsbeschreibung"
  description String?
  orderIndex  Int                  @default(0)
  textBlocks  CertificateTextBlock[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

// Text block templates with rating levels (1=sehr gut to 5=mangelhaft)
model CertificateTextBlock {
  id          String              @id @default(cuid())
  category    CertificateCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId  String
  title       String                        // Short description of this block
  content     String              @db.Text  // The actual text with placeholders like {firstName}, {lastName}, {jobTitle}
  rating      Int                 @default(2) // 1=sehr gut, 2=gut, 3=befriedigend, 4=ausreichend, 5=mangelhaft
  isDefault   Boolean             @default(false) // Use as default for this category/rating
  active      Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  sections    WorkCertificateSection[]

  @@index([categoryId, rating])
}

// Generated work certificates
model WorkCertificate {
  id            String                   @id @default(cuid())
  employee      Employee                 @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId    String
  type          CertificateType          @default(QUALIFIZIERT)
  title         String?                  // Custom title or auto-generated
  issueDate     DateTime                 @default(now())
  status        CertificateStatus        @default(DRAFT)
  // Snapshot of employee data at generation time
  employeeName  String                   // Full name at time of generation
  jobTitle      String?                  // Job title at time of generation
  startDate     DateTime                 // Employment start date
  endDate       DateTime?                // Employment end date (null for interim)
  // Final generated content
  fullContent   String?         @db.Text // Complete generated text
  notes         String?                  // Internal notes
  createdBy     User?                    @relation("CertificateCreatedBy", fields: [createdById], references: [id])
  createdById   String?
  approvedBy    User?                    @relation("CertificateApprovedBy", fields: [approvedById], references: [id])
  approvedById  String?
  approvedAt    DateTime?
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  sections      WorkCertificateSection[]

  @@index([employeeId])
  @@index([status])
}

enum CertificateStatus {
  DRAFT         // Being edited
  REVIEW        // Ready for review
  APPROVED      // Approved, ready to issue
  ISSUED        // Issued to employee
  ARCHIVED      // Archived
}

// Individual sections of a generated certificate
model WorkCertificateSection {
  id             String              @id @default(cuid())
  certificate    WorkCertificate     @relation(fields: [certificateId], references: [id], onDelete: Cascade)
  certificateId  String
  textBlock      CertificateTextBlock? @relation(fields: [textBlockId], references: [id])
  textBlockId    String?
  categoryKey    String              // Category key for ordering
  orderIndex     Int                 @default(0)
  content        String              @db.Text  // Actual content (may be edited from template)
  rating         Int?                // Rating used for this section
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([certificateId])
}

// --- Interne Projekte (Internal Project Applications) ---

enum ProjectApplicationStatus {
  PENDING       // Waiting for approval
  APPROVED      // Approved
  REJECTED      // Rejected
  WITHDRAWN     // Withdrawn by employee
}

model InternalProject {
  id            String              @id @default(cuid())
  name          String
  description   String?             @db.Text
  startDate     DateTime?
  endDate       DateTime?
  budget        Decimal?            @db.Decimal(10, 2)
  maxParticipants Int?
  isActive      Boolean             @default(true)
  createdById   String?
  createdBy     User?               @relation("ProjectCreatedBy", fields: [createdById], references: [id])
  applications  ProjectApplication[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

model ProjectApplication {
  id            String                    @id @default(cuid())
  project       InternalProject           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  employee      Employee                  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId    String
  status        ProjectApplicationStatus  @default(PENDING)
  motivation    String?                   @db.Text  // Why does employee want to join?
  hoursPerWeek  Int?                      // Proposed hours per week
  notes         String?                   @db.Text
  approvedById  String?
  approvedBy    User?                     @relation("ApplicationApprovedBy", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt

  @@unique([projectId, employeeId])
  @@index([employeeId])
  @@index([status])
}

// --- Fuhrpark Management (Fleet Management) ---

enum VehicleType {
  CAR
  VAN
  TRUCK
  MOTORCYCLE
  EBIKE
  OTHER
}

enum VehicleStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  DECOMMISSIONED
}

model Vehicle {
  id              String          @id @default(cuid())
  licensePlate    String          @unique
  brand           String
  model           String
  type            VehicleType     @default(CAR)
  status          VehicleStatus   @default(AVAILABLE)
  year            Int?
  color           String?
  vin             String?         @unique  // Vehicle Identification Number
  leasingCompany  String?
  leasingStart    DateTime?
  leasingEnd      DateTime?
  leasingMonthly  Decimal?        @db.Decimal(10, 2)
  fuelType        String?         // Diesel, Benzin, Elektro, Hybrid
  mileage         Int?            // Current mileage
  notes           String?         @db.Text
  assignments     VehicleAssignment[]
  costs           VehicleCost[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model VehicleAssignment {
  id            String      @id @default(cuid())
  vehicle       Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId     String
  employee      Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId    String
  startDate     DateTime    @default(now())
  endDate       DateTime?
  isActive      Boolean     @default(true)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([vehicleId])
  @@index([employeeId])
  @@index([isActive])
}

enum VehicleCostType {
  LEASING
  FUEL
  REPAIR
  MAINTENANCE
  INSURANCE
  TAX
  TOLL
  PARKING
  CLEANING
  OTHER
}

model VehicleCost {
  id          String          @id @default(cuid())
  vehicle     Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId   String
  type        VehicleCostType
  amount      Decimal         @db.Decimal(10, 2)
  date        DateTime
  description String?
  invoiceNo   String?
  mileage     Int?            // Mileage at time of cost
  createdById String?
  createdBy   User?           @relation("VehicleCostCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([vehicleId])
  @@index([type])
  @@index([date])
}

// --- HR Tickets ---

// LEGACY: Keep for backwards compatibility during migration
enum HRTicketCategory {
  BONUS           // Bonusabrechnung
  SALARY          // Gehaltsabrechnung
  ADDRESS_CHANGE  // Adressänderung
  BANK_CHANGE     // Bankverbindung ändern
  CONTRACT        // Vertragsfragen
  VACATION        // Urlaubsfragen
  SICK_LEAVE      // Krankmeldung
  ONBOARDING      // Onboarding-Fragen
  OFFBOARDING     // Offboarding-Fragen
  CERTIFICATE     // Zeugnisse
  OTHER           // Sonstiges
}

// Configurable ticket categories
model TicketCategory {
  id          String     @id @default(cuid())
  key         String     @unique  // Internal key e.g. "BONUS", "SALARY"
  label       String              // Display label e.g. "Bonusabrechnung"
  description String?
  color       String?             // Color for UI display
  icon        String?             // Icon name
  isActive    Boolean    @default(true)
  sortOrder   Int        @default(0)
  tickets     HRTicket[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

enum HRTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum HRTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING       // Waiting for info
  RESOLVED
  CLOSED
}

model HRTicket {
  id                String            @id @default(cuid())
  ticketNumber      String            @unique  // HR-2024-0001
  title             String
  description       String            @db.Text
  legacyCategory    HRTicketCategory  @default(OTHER) // LEGACY: Keep for backwards compatibility
  category          TicketCategory?   @relation(fields: [categoryId], references: [id])
  categoryId        String?           // New category system
  priority          HRTicketPriority  @default(MEDIUM)
  status            HRTicketStatus    @default(OPEN)
  employee          Employee?         @relation(fields: [employeeId], references: [id])
  employeeId        String?           // Optional: which employee is affected
  createdBy         User              @relation("TicketCreatedBy", fields: [createdById], references: [id])
  createdById       String
  assignedTo        User?             @relation("TicketAssignedTo", fields: [assignedToId], references: [id])
  assignedToId      String?
  resolvedAt        DateTime?
  closedAt          DateTime?
  comments          HRTicketComment[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status])
  @@index([categoryId])
  @@index([legacyCategory])
  @@index([createdById])
  @@index([assignedToId])
}

model HRTicketComment {
  id          String    @id @default(cuid())
  ticket      HRTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId    String
  content     String    @db.Text
  isInternal  Boolean   @default(false)  // Internal notes not visible to creator
  author      User      @relation(fields: [authorId], references: [id])
  authorId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([ticketId])
}

// --- Qualifikationen (Qualifications / Certifications) ---

// LEGACY: Keep for backwards compatibility during migration
enum QualificationType {
  FIRST_AID           // Ersthelfer
  FIRE_SAFETY         // Brandschutzhelfer
  SAFETY_OFFICER      // Sicherheitsbeauftragter
  DATA_PROTECTION     // Datenschutzbeauftragter
  WORKS_COUNCIL       // Betriebsrat
  APPRENTICE_TRAINER  // Ausbilder
  FORKLIFT            // Staplerführerschein
  CRANE               // Kranführerschein
  HAZMAT              // Gefahrgut
  ELECTRICAL          // Elektrofachkraft
  LANGUAGE            // Sprachzertifikat
  IT_CERTIFICATION    // IT-Zertifizierung
  PROJECT_MGMT        // Projektmanagement (PMP, PRINCE2)
  OTHER               // Sonstiges
}

// Configurable qualification categories/types
model QualificationCategory {
  id              String          @id @default(cuid())
  key             String          @unique  // Internal key e.g. "FIRST_AID"
  label           String                   // Display label e.g. "Ersthelfer"
  description     String?
  icon            String?                  // Emoji or icon name
  color           String?                  // Color for UI
  isCompanyWide   Boolean         @default(false)  // Required for company compliance
  defaultValidityMonths Int?               // Default validity for this category
  isActive        Boolean         @default(true)
  sortOrder       Int             @default(0)
  qualifications  Qualification[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Qualification {
  id              String                 @id @default(cuid())
  type            QualificationType      @default(OTHER) // LEGACY: Keep for backwards compatibility
  category        QualificationCategory? @relation(fields: [categoryId], references: [id])
  categoryId      String?                // New category system
  name            String                 // e.g. "Ersthelfer Grundkurs"
  description     String?
  isCompanyWide   Boolean                @default(false)
  validityMonths  Int?                   // How long is cert valid (null = permanent)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  employeeQuals   EmployeeQualification[]

  @@index([categoryId])
  @@index([type])
}

model EmployeeQualification {
  id              String        @id @default(cuid())
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId      String
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)
  qualificationId String
  obtainedDate    DateTime
  expiryDate      DateTime?     // When certification expires
  certificateNo   String?       // Certificate number
  issuer          String?       // Who issued the certification
  notes           String?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([employeeId, qualificationId])
  @@index([employeeId])
  @@index([qualificationId])
  @@index([expiryDate])
}
