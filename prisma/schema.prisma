generator client {
  provider = "prisma-client-js"
}

// --- HR On/Offboarding ---

enum TaskType {
  ONBOARDING
  OFFBOARDING
}

// Legacy enums retained to prevent Render db push from dropping existing columns before migrations run
enum LifecycleOwnerRole {
  ADMIN
  HR
  IT
  UNIT_LEAD
  TEAM_LEAD
  PEOPLE_MANAGER
}

enum TaskStatus {
  OPEN
  DONE
  BLOCKED
}

model TaskTemplate {
  id              String        @id @default(cuid())
  title           String
  description     String?
  type            TaskType
  // Legacy column to satisfy db push in environments that still have it
  ownerRole       LifecycleOwnerRole?
  // New relational role; renamed field to avoid name clash with legacy column
  role            LifecycleRole? @relation("LifecycleRoleTaskTemplates", fields: [ownerRoleId], references: [id])
  ownerRoleId     String?
  relativeDueDays Int           // relative to startDate/exitDate depending on type
  active          Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  assignments TaskAssignment[]

  @@unique([title, type])
}

model TaskAssignment {
  id             String        @id @default(cuid())
  employee       Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId     String
  template       TaskTemplate  @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  taskTemplateId String
  type           TaskType
  status         LifecycleStatus @relation("LifecycleStatusTaskAssignments", fields: [statusId], references: [id])
  statusId       String
  dueDate        DateTime
  ownerRole      LifecycleRole @relation("LifecycleRoleTaskAssignments", fields: [ownerRoleId], references: [id])
  ownerRoleId    String
  // Keep old DB columns mapped as Unsupported to avoid type changes via db push
  ownerRoleLegacy Unsupported("LifecycleOwnerRole")? @map("ownerRole")
  statusLegacy    Unsupported("TaskStatus")?         @map("status")
  notes          String?
  completedAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // optional links for asset/access fulfillment
  assets   Asset[]  @relation("AssignmentAssets")
  accesses Access[] @relation("AssignmentAccesses")

  @@unique([employeeId, taskTemplateId])
  @@index([employeeId, statusId, dueDate])
}

model Asset {
  id                   String          @id @default(cuid())
  name                 String
  serial               String?
  // either assigned directly to employee, or linked via task assignment
  assignedToEmployee   Employee?       @relation("EmployeeAssets", fields: [assignedToEmployeeId], references: [id])
  assignedToEmployeeId String?
  assignment           TaskAssignment? @relation("AssignmentAssets", fields: [assignmentId], references: [id])
  assignmentId         String?
  notes                String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@index([assignedToEmployeeId])
}

model Access {
  id                   String          @id @default(cuid())
  system               String
  account              String?
  assignedToEmployee   Employee?       @relation("EmployeeAccesses", fields: [assignedToEmployeeId], references: [id])
  assignedToEmployeeId String?
  assignment           TaskAssignment? @relation("AssignmentAccesses", fields: [assignmentId], references: [id])
  assignmentId         String?
  notes                String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@index([assignedToEmployeeId])
}

model EmployeeDocument {
  id           String   @id @default(cuid())
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId   String
  title        String
  docType      String
  url          String?
  storageKey   String?
  uploadedBy   User?    @relation("EmployeeDocumentUploadedBy", fields: [uploadedById], references: [id])
  uploadedById String?
  createdAt    DateTime @default(now())
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employee {
  id                 String               @id @default(cuid())
  firstName          String
  lastName           String
  startDate          DateTime
  birthDate          DateTime
  email              String?              @unique
  status             EmployeeStatus       @default(ACTIVE)
  exitDate           DateTime?
  jobTitle           String?
  contractType       ContractType?        @default(PERMANENT)
  employmentType     EmploymentType?      @default(FULL_TIME)
  weeklyHours        Int?                 @default(40)
  remoteQuota        Int?                 @default(0)
  unit               Unit?                @relation(fields: [unitId], references: [id])
  unitId             String?
  department         Department?          @relation(fields: [departmentId], references: [id])
  departmentId       String?
  team               Team?                @relation(fields: [teamId], references: [id])
  teamId             String?
  location           Location?            @relation(fields: [locationId], references: [id])
  locationId         String?
  assignments        EmployeeAssignment[]
  absences           Absence[]
  lifecycleProcesses LifecycleProcess[]
  lifecycleTasks     TaskAssignment[]
  assets             Asset[]              @relation("EmployeeAssets")
  accesses           Access[]             @relation("EmployeeAccesses")
  documents          EmployeeDocument[]
  reminders          Reminder[]
  lockAll            Boolean              @default(false)
  lockFirstName      Boolean              @default(false)
  lockLastName       Boolean              @default(false)
  lockStartDate      Boolean              @default(false)
  lockBirthDate      Boolean              @default(false)
  lockEmail          Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@unique([firstName, lastName, birthDate])
}

model Unit {
  id           String               @id @default(cuid())
  name         String
  leader       String?
  deputy       String?
  department   Department?          @relation(fields: [departmentId], references: [id])
  departmentId String?
  location     Location?            @relation(fields: [locationId], references: [id])
  locationId   String?
  employees    Employee[]
  teams        Team[]
  users        User[]
  absences     Absence[]
  assignments  EmployeeAssignment[] @relation("AssignmentUnit")
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@unique([name])
}

model Department {
  id          String               @id @default(cuid())
  name        String
  description String?
  units       Unit[]
  employees   Employee[]
  teams       Team[]
  absences    Absence[]
  assignments EmployeeAssignment[] @relation("AssignmentDepartment")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([name])
}

model Team {
  id           String               @id @default(cuid())
  name         String
  unit         Unit?                @relation(fields: [unitId], references: [id])
  unitId       String?
  department   Department?          @relation(fields: [departmentId], references: [id])
  departmentId String?
  employees    Employee[]
  absences     Absence[]
  assignments  EmployeeAssignment[] @relation("AssignmentTeam")
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@unique([name])
}

model Location {
  id          String               @id @default(cuid())
  name        String
  address     String?
  units       Unit[]
  employees   Employee[]
  absences    Absence[]
  assignments EmployeeAssignment[] @relation("AssignmentLocation")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([name])
}

model EmployeeAssignment {
  id             String          @id @default(cuid())
  employee       Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId     String
  unitId         String?
  unit           Unit?           @relation("AssignmentUnit", fields: [unitId], references: [id])
  departmentId   String?
  department     Department?     @relation("AssignmentDepartment", fields: [departmentId], references: [id])
  teamId         String?
  team           Team?           @relation("AssignmentTeam", fields: [teamId], references: [id])
  locationId     String?
  location       Location?       @relation("AssignmentLocation", fields: [locationId], references: [id])
  jobTitle       String?
  contractType   ContractType?
  employmentType EmploymentType?
  weeklyHours    Int?
  remoteQuota    Int?
  startedAt      DateTime        @default(now())
  endedAt        DateTime?
  createdAt      DateTime        @default(now())

  @@index([employeeId, startedAt])
}

enum UserRole {
  ADMIN
  HR
  PEOPLE_MANAGER
  TEAM_LEAD
  UNIT_LEAD
}

enum ContractType {
  PERMANENT
  FIXED_TERM
  FREELANCE
  TEMPORARY
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  WORKING_STUDENT
  INTERN
  APPRENTICE
}

model Absence {
  id             String        @id @default(cuid())
  employee       Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId     String
  unit           Unit?         @relation(fields: [unitId], references: [id])
  unitId         String?
  department     Department?   @relation(fields: [departmentId], references: [id])
  departmentId   String?
  team           Team?         @relation(fields: [teamId], references: [id])
  teamId         String?
  location       Location?     @relation(fields: [locationId], references: [id])
  locationId     String?
  type           AbsenceType   @default(VACATION)
  status         AbsenceStatus @default(PENDING)
  startDate      DateTime
  endDate        DateTime
  description    String?
  managerComment String?
  createdBy      User?         @relation("AbsenceCreatedBy", fields: [createdById], references: [id])
  createdById    String?
  approvedBy     User?         @relation("AbsenceApprovedBy", fields: [approvedById], references: [id])
  approvedById   String?
  approvedAt     DateTime?
  declineReason  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([employeeId, startDate, endDate])
  @@index([unitId, startDate, endDate])
}

enum AbsenceType {
  VACATION
  SICKNESS
  PARENTAL_LEAVE
  TRAINING
  BUSINESS_TRIP
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String?
  passwordHash            String
  role                    UserRole           @default(UNIT_LEAD)
  unit                    Unit?              @relation(fields: [unitId], references: [id])
  unitId                  String?
  sessions                Session[]
  absencesCreated         Absence[]          @relation("AbsenceCreatedBy")
  absencesApproved        Absence[]          @relation("AbsenceApprovedBy")
  documentsUploaded       EmployeeDocument[] @relation("EmployeeDocumentUploadedBy")
  completedLifecycleTasks LifecycleTask[]    @relation("LifecycleTaskCompletedBy")
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

enum EmployeeStatus {
  ACTIVE
  ONBOARDING
  OFFBOARDING
  EXITED
}

model Setting {
  id                     Int     @id @default(1)
  managerEmails          String  @default("")
  birthdayEmailTemplate  String  @default("Happy Birthday, {{firstName}}!")
  jubileeEmailTemplate   String  @default("Congrats on {{years}} years, {{firstName}}!")
  jubileeYearsCsv        String  @default("5,10,15,20,25,30,35,40")
  smtpHost               String  @default("")
  smtpPort               Int     @default(465)
  smtpUser               String  @default("")
  smtpPass               String  @default("")
  smtpFrom               String  @default("")
  smtpSecure             Boolean @default(true)
  smtpRejectUnauthorized Boolean @default(true)
  sendOnBirthday         Boolean @default(true)
  sendOnJubilee          Boolean @default(true)
  dailySendHour          Int     @default(8) // 0-23
}

model EmployeeImportLog {
  id                String   @id @default(cuid())
  created           Int
  updated           Int
  skippedLocked     Int
  exited            Int
  skippedExitLocked Int
  reactivated       Int
  createdAt         DateTime @default(now())
}

// --- On/Offboarding lifecycle ---

enum LifecycleType {
  ONBOARDING
  OFFBOARDING
}

model LifecycleRole {
  id          String               @id @default(cuid())
  key         String               @unique
  label       String
  description String?
  type        LifecycleType?
  orderIndex  Int                  @default(0)
  active      Boolean              @default(true)
  templates   LifecycleTaskTemplate[]
  tasks       LifecycleTask[]
  taskTemplates TaskTemplate[] @relation("LifecycleRoleTaskTemplates")
  taskAssignments TaskAssignment[] @relation("LifecycleRoleTaskAssignments")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model LifecycleStatus {
  id         String           @id @default(cuid())
  key        String           @unique
  label      String
  description String?
  type       LifecycleType?
  orderIndex Int              @default(0)
  active     Boolean          @default(true)
  isDone     Boolean          @default(false)
  isDefault  Boolean          @default(false)
  tasks      LifecycleTask[]
  taskAssignments TaskAssignment[] @relation("LifecycleStatusTaskAssignments")
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model LifecycleTemplate {
  id          String                  @id @default(cuid())
  title       String
  type        LifecycleType
  description String?
  active      Boolean                 @default(true)
  tasks       LifecycleTaskTemplate[]
  processes   LifecycleProcess[]
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@unique([title, type])
}

model LifecycleTaskTemplate {
  id           String            @id @default(cuid())
  template     LifecycleTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId   String
  title        String
  description  String?
  ownerRole    LifecycleRole     @relation(fields: [ownerRoleId], references: [id])
  ownerRoleId  String
  relativeDays Int // relative due date offset from start (onboarding) or exit (offboarding)
  orderIndex   Int               @default(0)
}

model LifecycleProcess {
  id         String            @id @default(cuid())
  employee   Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String
  template   LifecycleTemplate @relation(fields: [templateId], references: [id])
  templateId String
  type       LifecycleType
  startedAt  DateTime          @default(now())
  closedAt   DateTime?
  tasks      LifecycleTask[]
}

model LifecycleTask {
  id            String           @id @default(cuid())
  process       LifecycleProcess @relation(fields: [processId], references: [id], onDelete: Cascade)
  processId     String
  title         String
  description   String?
  ownerRole     LifecycleRole    @relation(fields: [ownerRoleId], references: [id])
  ownerRoleId   String
  status        LifecycleStatus  @relation(fields: [statusId], references: [id])
  statusId      String
  dueDate       DateTime?
  completedAt   DateTime?
  completedBy   User?            @relation("LifecycleTaskCompletedBy", fields: [completedById], references: [id])
  completedById String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([processId])
}

// --- Reminders ---

enum ReminderType {
  GEHALT
  MEILENSTEIN
  SONDERBONUS
  STAFFELBONUS
  URLAUBSGELD
  WEIHNACHTSGELD
}

model Reminder {
  id          String        @id @default(cuid())
  type        ReminderType
  description String?
  employee    Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId  String
  dueDate     DateTime
  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  schedules   ReminderSchedule[]
  recipients  ReminderRecipient[]
  sendLogs    ReminderSendLog[]
}

model ReminderSchedule {
  id          String    @id @default(cuid())
  reminder    Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  reminderId  String
  label       String
  daysBefore  Int       // 0 = at due date, positive = days before
  timeOfDay   String?   // optional HH:mm for sending window
  orderIndex  Int       @default(0)
}

model ReminderRecipient {
  id          String    @id @default(cuid())
  reminder    Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  reminderId  String
  email       String
  orderIndex  Int       @default(0)
}

model ReminderSendLog {
  id           String    @id @default(cuid())
  reminder     Reminder  @relation(fields: [reminderId], references: [id], onDelete: Cascade)
  reminderId   String
  scheduleLabel String
  targetEmail  String
  sentAt       DateTime  @default(now())

  @@index([reminderId, sentAt])
  @@unique([reminderId, scheduleLabel, targetEmail, sentAt])
}
